<match <%= @tag || "OptimisPt.Rails" %>>
  type copy
  <store>
    type forward
    flush_interval <%= @flush_interval || "60s" %>
    #buffer_type memory     # memory or file
    #buffer_chunk_limit 8m  # Size of each buffer chunk, default = 8m (k=kB, m=MB, g=GB)
    #buffer_queue_limit 64  # Length limit of the chunk queue, default = 64

    retry_wait 1s           # Interval between write retries, default = 1.0
    retry_limit 10          # Number of retries
    send_timeout 60s        # Timeout time when sending event logs, default = 60s
    recover_wait 10s        # Wait time before accepting a server fault recovery, default = 10s

    <server> # The destination servers, at least one is required
      name <%= @name || "AuditLogDB" %>
      host <%= @host || "AuditLogDB.internal" %>
      port <%= @port || "24224" %>
    </server>

    <secondary> # The backup destination that is used when all servers are unavailable
      type file
      path <%= @secondary_path || "/var/log/td-agent/fluentd_forward_fail.pt.log" %>
      utc
      buffer_chunk_limit 1024m
    </secondary>
  </store>
  <store>
    type rewrite_tag_filter
    rewriterule1 path ^\/keep_alive clear
    rewriterule2 user_id .+ Optimis.Rails.BigQuery
    rewriterule3 path .+ clear
  </store>

</match>
<filter Optimis.Rails.BigQuery>
  @type record_modifier

  whitelist_keys method, path, controller, action, status, time, practice_id, clinic_id, user_id, patient_id, jsonized_record
  <record>
    jsonized_record ${record.to_json}
  </record>
</filter>

# forwarding to bigquery plugin
<match Optimis.Rails.BigQuery>
  @type bigquery
  method load

  buffer_type file
  buffer_path /var/log/td-agent/optimis.*.buffer
  flush_interval 1m
  flush_at_shutdown true

  auth_method json_key
  json_key /var/www/optimis/config/bigquery_keyfile.json

  project "rapid-compound-160705"
  dataset <%= "optimis_#{@env}" %>

  utc
  time_slice_format %Y%m%d_%H
  time_slice_wait 10m

  auto_create_table true
  tables log_entries_%{time_slice}

  schema [
  {"name": "method", "type": "STRING"},
  {"name": "path", "type": "STRING"},
  {"name": "controller", "type": "STRING"},
  {"name": "action", "type": "STRING"},
  {"name": "status", "type": "INTEGER"},
  {"name": "time", "type": "TIMESTAMP"},
  {"name": "practice_id", "type": "INTEGER"},
  {"name": "clinic_id", "type": "INTEGER"},
  {"name": "user_id", "type": "INTEGER"},
  {"name": "patient_id", "type": "INTEGER"},
  {"name": "jsonized_record", "type": "STRING"}
  ]

  time_format %FT%T%:z
  time_field time

</match>


