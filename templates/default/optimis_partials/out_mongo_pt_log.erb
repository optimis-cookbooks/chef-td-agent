<% @tag ||= "OptimisPt.Rails" -%>
<% @host ||= "AuditLogDB.internal" -%>
<% @port ||= "27017" -%>
<% @database ||= "optimis_prism_production" -%>
<% @flowcounter_unit ||= "minute" -%>
<% @datacounter_interval ||= "600" -%>

<match <%= @tag %>.*>
  type copy
  <store>
    type rewrite
    remove_prefix <%= @tag %>
    add_prefix audit_log
  </store>
  <store>
    type map
    map [["audit_log.patients", time, {"practice_id"=>record["practice_id"].to_i, "patient_id"=>record["patient_id"].to_i, "patient_name"=>record["patient_name"]}], ["audit_log.users", time, {"practice_id"=>record["practice_id"].to_i, "user_id"=>record["user_id"].to_i, "user_name"=>record["user_name"]}]]
    multi true
  </store>
  <store>
    type flowcounter
    input_tag_remove_prefix <%= @tag %>
    unit <%= @flowcounter_unit %>
    count_keys *
    tag audit_log.flow_count
  </store>
  <store>
    type datacounter
    input_tag_remove_prefix <%= @tag %>
    count_interval <%= @datacounter_interval %>
    count_key method
    pattern1 GET ^GET$
    pattern2 POST ^POST$
    pattern3 PUT ^PUT$
    pattern4 DELETE ^DELETE$
    outcast_unmatched yes
    output_messages yes
    tag audit_log.method_count
  </store>
</match>

<match audit_log.*>
  type mongo
  host <%= @host %>
  port <%= @port %>
  database <%= @database %>
  tag_mapped
  remove_tag_prefix audit_log.
</match>
