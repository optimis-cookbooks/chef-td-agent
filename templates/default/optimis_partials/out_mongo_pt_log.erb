<match <%= @tag ||= "OptimisPt.Rails" %>.*>
  type copy
  <store>
    type mongo
    host <%= @host ||= "AuditLogDB.internal" %>
    port <%= @port ||= "27017" %>
    database <%= @database ||= "optimis_prism_production" %>
    tag_mapped
    remove_tag_prefix <%= @tag %>.
  </store>
  <store>
    type map
    map [["log_entries.patients", time, {"practice_id"=>record["practice_id"], "patient_id"=>record["patient_id"], "patient_name"=>record["patient_name"]}],["log_entries.users", time, {"practice_id"=>record["practice_id"].to_i, "user_id"=>record["user_id"], "user_name"=>record["user_name"]}]]
    multi true
  </store>
  <store>
    type flowcounter
    input_tag_remove_prefix <%= @tag %>
    unit <%= @flowcounter_unit || "minute" %>
    count_keys *
    tag log_entries.flow_count
  </store>
  <store>
    type datacounter
    input_tag_remove_prefix <%= @tag %>
    count_interval <%= @datacounter_interval || "600" %>
    count_key method
    pattern1 GET ^GET$
    pattern2 POST ^POST$
    pattern3 PUT ^PUT$
    pattern4 DELETE ^DELETE$
    outcast_unmatched yes
    output_messages yes
    tag log_entries.method_count
  </store>
</match>

<match log_entries.*>
  type copy
  <store>
    type mongo
    host <%= @host %>
    port <%= @port %>
    database <%= @database %>
    ignore_duplicate_key_error true
    tag_mapped
    remove_tag_prefix log_entries.
  </store>
  <store>
    type file
    path /var/log/td-agent/fluentd.counter.log
  </store>
</match>
