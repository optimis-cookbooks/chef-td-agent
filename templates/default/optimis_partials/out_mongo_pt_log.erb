<match <%= @tag ||= "OptimisPt.Rails" %>.*>
  type copy
  <store>
    type mongo
    host <%= @host ||= "AuditLogDB.internal" %>
    port <%= @port ||= "27017" %>
    database <%= @database ||= "optimis_prism_production" %>
    tag_mapped
    remove_tag_prefix <%= @tag %>.
  </store>
  <store>
    type flowcounter
    input_tag_remove_prefix <%= @tag %>
    unit <%= @flowcounter_unit || "minute" %>
    count_keys *
    tag fluentd.counter.flow_count
  </store>
  <store>
    type datacounter
    input_tag_remove_prefix <%= @tag %>
    count_interval <%= @datacounter_interval || "10m" %>
    count_key method
    pattern1 GET ^GET$
    pattern2 POST ^POST$
    pattern3 PUT ^PUT$
    pattern4 DELETE ^DELETE$
    outcast_unmatched yes
    output_messages yes
    tag fluentd.counter.method_count
  </store>
</match>

<match fluentd.counter.*>
  type copy
  <store>
  type mongo
  host <%= @host %>
  port <%= @port %>
  database <%= @database %>
  tag_mapped
  remove_tag_prefix fluentd.counter.
  </store>
  <store>
    type file
    path /var/log/td-agent/fluentd.counter.log
  </store>
</match>
