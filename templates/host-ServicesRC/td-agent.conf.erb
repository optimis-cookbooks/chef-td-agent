# LOG AGGREGATOR CONFIG
<source>
  type forward
  port 24224    # The port to listen to, default = 24224
  bind 0.0.0.0  # The bind address to listen to, default = 0.0.0.0 (all addresses)
</source>

<source>
  type monitor_agent
  bind 0.0.0.0
  port 24220
</source>

<source>
  type debug_agent
  bind 127.0.0.1
  port 24230
</source>

<match OptimisPt.Rails.*>
  type copy
  <store>
    type mongo
    host <%= node['td_agent']['aggregator']['mongo_ip'] %>
    port <%= node['td_agent']['aggregator']['mongo_port'] %>
    database <%= node['td_agent']['aggregator']['mongo_db'] %>
    tag_mapped
    remove_tag_prefix OptimisPt.Rails.
  </store>
  <store>
    type flowcounter
    unit hour
    count_keys *
    aggregate all
    tag fluentd.counter.flow_count
  </store>
  <store>
    type datacounter
    unit hour
    count_key status
    pattern1 2xx ^2\d\d$
    pattern2 3xx ^3\d\d$
    pattern3 4xx ^4\d\d$
    pattern4 5xx ^5\d\d$
    outcast_unmatched yes # '*_percentage' fields culculated without 'unmatched' counts, and
                          # 'unmatched_percentage' field will not be produced
    output_messages yes
    tag fluentd.counter.status_count
  </store>
  <store>
    type datacounter
    unit hour
    count_key method
    pattern1 GET ^GET$
    pattern2 POST ^POST$
    outcast_unmatched yes # '*_percentage' fields culculated without 'unmatched' counts, and
                          # 'unmatched_percentage' field will not be produced
    output_messages yes
    tag fluentd.counter.method_count
  </store>
</match>

<match fluentd.counter.*>
  type mongo
  host <%= node['td_agent']['aggregator']['mongo_ip'] %>
  port <%= node['td_agent']['aggregator']['mongo_port'] %>
  database <%= node['td_agent']['aggregator']['mongo_db_for_counter'] %>
  tag_mapped
  remove_tag_prefix fluentd.counter.
</match>
